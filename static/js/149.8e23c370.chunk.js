"use strict";(self.webpackChunkclient=self.webpackChunkclient||[]).push([[149],{149:(e,t,i)=>{i.d(t,{MOBI:()=>Y,isMOBI:()=>B});var r=i(473),n=i(341);const s=e=>{if(!e)return"";const t=document.createElement("textarea");return t.innerHTML=e,t.value},o={XML:"application/xml",XHTML:"application/xhtml+xml",HTML:"text/html",CSS:"text/css",SVG:"image/svg+xml"},a={name:[0,32,"string"],type:[60,4,"string"],creator:[64,4,"string"],numRecords:[76,2,"uint"]},l={compression:[0,2,"uint"],numTextRecords:[8,2,"uint"],recordSize:[10,2,"uint"],encryption:[12,2,"uint"]},c={magic:[16,4,"string"],length:[20,4,"uint"],type:[24,4,"uint"],encoding:[28,4,"uint"],uid:[32,4,"uint"],version:[36,4,"uint"],titleOffset:[84,4,"uint"],titleLength:[88,4,"uint"],localeRegion:[94,1,"uint"],localeLanguage:[95,1,"uint"],resourceStart:[108,4,"uint"],huffcdic:[112,4,"uint"],numHuffcdic:[116,4,"uint"],exthFlag:[128,4,"uint"],trailingFlags:[240,4,"uint"],indx:[244,4,"uint"]},u={resourceStart:[108,4,"uint"],fdst:[192,4,"uint"],numFdst:[196,4,"uint"],frag:[248,4,"uint"],skel:[252,4,"uint"],guide:[260,4,"uint"]},d={magic:[0,4,"string"],length:[4,4,"uint"],count:[8,4,"uint"]},h={magic:[0,4,"string"],length:[4,4,"uint"],type:[8,4,"uint"],idxt:[20,4,"uint"],numRecords:[24,4,"uint"],encoding:[28,4,"uint"],language:[32,4,"uint"],total:[36,4,"uint"],ordt:[40,4,"uint"],ligt:[44,4,"uint"],numLigt:[48,4,"uint"],numCncx:[52,4,"uint"]},f={magic:[0,4,"string"],length:[4,4,"uint"],numControlBytes:[8,4,"uint"]},g={magic:[0,4,"string"],offset1:[8,4,"uint"],offset2:[12,4,"uint"]},p={magic:[0,4,"string"],length:[4,4,"uint"],numEntries:[8,4,"uint"],codeLength:[12,4,"uint"]},m={magic:[0,4,"string"],numEntries:[8,4,"uint"]},b={flags:[8,4,"uint"],dataStart:[12,4,"uint"],keyLength:[16,4,"uint"],keyStart:[20,4,"uint"]},v={1252:"windows-1252",65001:"utf-8"},w={100:["creator","string",!0],101:["publisher"],103:["description"],104:["isbn"],105:["subject","string",!0],106:["date"],108:["contributor","string",!0],109:["rights"],110:["subjectCode","string",!0],112:["source","string",!0],113:["asin"],121:["boundary","uint"],122:["fixedLayout"],125:["numResources","uint"],126:["originalResolution"],127:["zeroGutter"],128:["zeroMargin"],129:["coverURI"],132:["regionMagnification"],201:["coverOffset","uint"],202:["thumbnailOffset","uint"],503:["title"],524:["language","string",!0],527:["pageProgressionDirection"]},A={1:["ar","ar-SA","ar-IQ","ar-EG","ar-LY","ar-DZ","ar-MA","ar-TN","ar-OM","ar-YE","ar-SY","ar-JO","ar-LB","ar-KW","ar-AE","ar-BH","ar-QA"],2:["bg"],3:["ca"],4:["zh","zh-TW","zh-CN","zh-HK","zh-SG"],5:["cs"],6:["da"],7:["de","de-DE","de-CH","de-AT","de-LU","de-LI"],8:["el"],9:["en","en-US","en-GB","en-AU","en-CA","en-NZ","en-IE","en-ZA","en-JM",null,"en-BZ","en-TT","en-ZW","en-PH"],10:["es","es-ES","es-MX",null,"es-GT","es-CR","es-PA","es-DO","es-VE","es-CO","es-PE","es-AR","es-EC","es-CL","es-UY","es-PY","es-BO","es-SV","es-HN","es-NI","es-PR"],11:["fi"],12:["fr","fr-FR","fr-BE","fr-CA","fr-CH","fr-LU","fr-MC"],13:["he"],14:["hu"],15:["is"],16:["it","it-IT","it-CH"],17:["ja"],18:["ko"],19:["nl","nl-NL","nl-BE"],20:["no","nb","nn"],21:["pl"],22:["pt","pt-BR","pt-PT"],23:["rm"],24:["ro"],25:["ru"],26:["hr",null,"sr"],27:["sk"],28:["sq"],29:["sv","sv-SE","sv-FI"],30:["th"],31:["tr"],32:["ur"],33:["id"],34:["uk"],35:["be"],36:["sl"],37:["et"],38:["lv"],39:["lt"],41:["fa"],42:["vi"],43:["hy"],44:["az"],45:["eu"],46:["hsb"],47:["mk"],48:["st"],49:["ts"],50:["tn"],52:["xh"],53:["zu"],54:["af"],55:["ka"],56:["fo"],57:["hi"],58:["mt"],59:["se"],62:["ms"],63:["kk"],65:["sw"],67:["uz",null,"uz-UZ"],68:["tt"],69:["bn"],70:["pa"],71:["gu"],72:["or"],73:["ta"],74:["te"],75:["kn"],76:["ml"],77:["as"],78:["mr"],79:["sa"],82:["cy","cy-GB"],83:["gl","gl-ES"],87:["kok"],97:["ne"],98:["fy"]},y=(e,t)=>{const i=new e.constructor(e.length+t.length);return i.set(e),i.set(t,e.length),i},x=(e,t,i)=>{const r=new e.constructor(e.length+t.length+i.length);return r.set(e),r.set(t,e.length),r.set(i,e.length+t.length),r},R=new TextDecoder,O=e=>R.decode(e),S=e=>{if(!e)return;const t=e.byteLength,i=4===t?"getUint32":2===t?"getUint16":"getUint8";return new DataView(e)[i](0)},M=(e,t)=>Object.fromEntries(Array.from(Object.entries(e)).map((e=>{let[i,[r,n,s]]=e;return[i,("string"===s?O:S)(t.slice(r,r+n))]}))),L=e=>new TextDecoder(v[e]),T=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=0,r=0;for(const n of e.subarray(t,t+4))if(i=i<<7|(127&n)>>>0,r++,128&n)break;return{value:i,length:r}},E=e=>{let t=0;for(const i of e.subarray(-4))128&i&&(t=0),t=t<<7|127&i;return t},k=e=>{let t=0;for(;e>0;e>>=1)1===(1&e)&&t++;return t},C=e=>{let t=0;for(;0===(1&e);)e>>=1,t++;return t},j=e=>{let t=[];for(let i=0;i<e.length;i++){const r=e[i];if(0===r)t.push(0);else if(r<=8)for(const n of e.subarray(i+1,(i+=r)+1))t.push(n);else if(r<=127)t.push(r);else if(r<=191){const n=r<<8|e[1+i++],s=(16383&n)>>>3,o=3+(7&n);for(let e=0;e<o;e++)t.push(t[t.length-s])}else t.push(32,128^r)}return Uint8Array.from(t)},I=(e,t)=>{const i=t+32,r=i>>3;let n=0n;for(let o=t>>3;o<=r;o++){var s;n=n<<8n|BigInt(null!==(s=e[o])&&void 0!==s?s:0)}return n>>8n-BigInt(7&i)&0xffffffffn},U=async(e,t)=>{const i=await t(e),r=M(h,i);if("INDX"!==r.magic)throw new Error("Invalid INDX record");const n=L(r.encoding),s=i.slice(r.length),o=M(f,s);if("TAGX"!==o.magic)throw new Error("Invalid TAGX section");const a=(o.length-12)/4,l=Array.from({length:a},((e,t)=>new Uint8Array(s.slice(12+4*t,12+4*t+4)))),c={};let u=0;for(let h=0;h<r.numCncx;h++){const i=await t(e+r.numRecords+h+1),s=new Uint8Array(i);for(let e=0;e<s.byteLength;){const t=e,{value:r,length:o}=T(s,e);e+=o;const a=i.slice(e,e+r);e+=r,c[u+t]=n.decode(a)}u+=65536}const d=[];for(let f=0;f<r.numRecords;f++){const i=await t(e+1+f),r=new Uint8Array(i),n=M(h,i);if("INDX"!==n.magic)throw new Error("Invalid INDX record");for(let e=0;e<n.numRecords;e++){const t=n.idxt+4+2*e,s=S(i.slice(t,t+2)),a=S(i.slice(s,s+1)),c=O(i.slice(s+1,s+1+a)),u=[],h=s+1+a;let f=0,g=h+o.numControlBytes;for(const[e,n,o,d]of l){if(1&d){f++;continue}const t=h+f,s=S(i.slice(t,t+1))&o;if(s===o)if(k(o)>1){const{value:t,length:i}=T(r,g);u.push([e,null,t,n]),g+=i}else u.push([e,1,null,n]);else u.push([e,s>>C(o),null,n])}const p={};for(const[e,i,n,o]of u){const t=[];if(null!=i)for(let e=0;e<i*o;e++){const{value:e,length:i}=T(r,g);t.push(e),g+=i}else{let e=0;for(;e<n;){const{value:i,length:n}=T(r,g);t.push(i),g+=n,e+=n}}p[e]=t}d.push({name:c,tagMap:p})}}return{table:d,cncx:c}},B=async e=>"BOOKMOBI"===O(await e.slice(60,68).arrayBuffer());var P=(0,n.A)("file"),F=(0,n.A)("offsets");class D{constructor(){Object.defineProperty(this,P,{writable:!0,value:void 0}),Object.defineProperty(this,F,{writable:!0,value:void 0})}async open(e){(0,r.A)(this,P)[P]=e;const t=M(a,await e.slice(0,78).arrayBuffer());this.pdb=t;const i=await e.slice(78,78+8*t.numRecords).arrayBuffer();(0,r.A)(this,F)[F]=Array.from({length:t.numRecords},((e,t)=>S(i.slice(8*t,8*t+4)))).map(((e,t,i)=>[e,i[t+1]]))}loadRecord(e){const t=(0,r.A)(this,F)[F][e];if(!t)throw new RangeError("Record index out of bounds");return(0,r.A)(this,P)[P].slice(...t).arrayBuffer()}async loadMagic(e){const t=(0,r.A)(this,F)[F][e][0];return O(await(0,r.A)(this,P)[P].slice(t,t+4).arrayBuffer())}}var H=(0,n.A)("start"),z=(0,n.A)("resourceStart"),N=(0,n.A)("decoder"),X=(0,n.A)("encoder"),G=(0,n.A)("decompress"),q=(0,n.A)("removeTrailingEntries"),V=(0,n.A)("getHeaders"),Z=(0,n.A)("setup");class Y extends D{constructor(e){let{unzlib:t}=e;super(),Object.defineProperty(this,Z,{value:W}),Object.defineProperty(this,V,{value:K}),Object.defineProperty(this,H,{writable:!0,value:0}),Object.defineProperty(this,z,{writable:!0,value:void 0}),Object.defineProperty(this,N,{writable:!0,value:void 0}),Object.defineProperty(this,X,{writable:!0,value:void 0}),Object.defineProperty(this,G,{writable:!0,value:void 0}),Object.defineProperty(this,q,{writable:!0,value:void 0}),this.unzlib=t}async open(e){await super.open(e),this.headers=(0,r.A)(this,V)[V](await super.loadRecord(0)),(0,r.A)(this,z)[z]=this.headers.mobi.resourceStart;let t=this.headers.mobi.version>=8;if(!t){var i;const e=null===(i=this.headers.exth)||void 0===i?void 0:i.boundary;if(e<4294967295)try{this.headers=(0,r.A)(this,V)[V](await super.loadRecord(e)),(0,r.A)(this,H)[H]=e,t=!0}catch(n){console.warn(n),console.warn("Failed to open KF8; falling back to MOBI")}}return await(0,r.A)(this,Z)[Z](),t?new Oe(this).init():new ne(this).init()}decode(){return(0,r.A)(this,N)[N].decode(...arguments)}encode(){return(0,r.A)(this,X)[X].encode(...arguments)}loadRecord(e){return super.loadRecord((0,r.A)(this,H)[H]+e)}loadMagic(e){return super.loadMagic((0,r.A)(this,H)[H]+e)}loadText(e){return this.loadRecord(e+1).then((e=>new Uint8Array(e))).then((0,r.A)(this,q)[q]).then((0,r.A)(this,G)[G])}async loadResource(e){const t=await super.loadRecord((0,r.A)(this,z)[z]+e),i=O(t.slice(0,4));return"FONT"===i?(async(e,t)=>{const{flags:i,dataStart:r,keyLength:n,keyStart:s}=M(b,e),o=new Uint8Array(e.slice(r));if(2&i){const t=16===n?1024:1040,i=new Uint8Array(e.slice(s,s+n)),r=Math.min(t,o.length);for(var a=0;a<r;a++)o[a]=o[a]^i[a%i.length]}if(1&i)try{return await t(o)}catch(l){console.warn(l),console.warn("Failed to decompress font")}return o})(t,this.unzlib):"VIDE"===i||"AUDI"===i?t.slice(12):t}getNCX(){const e=this.headers.mobi.indx;if(e<4294967295)return(async(e,t)=>{const{table:i,cncx:r}=await U(e,t),n=i.map(((e,t)=>{var i,n,s,o,a,l,c;let{tagMap:u}=e;return{index:t,offset:null===(i=u[1])||void 0===i?void 0:i[0],size:null===(n=u[2])||void 0===n?void 0:n[0],label:null!==(s=r[u[3]])&&void 0!==s?s:"",headingLevel:null===(o=u[4])||void 0===o?void 0:o[0],pos:u[6],parent:null===(a=u[21])||void 0===a?void 0:a[0],firstChild:null===(l=u[22])||void 0===l?void 0:l[0],lastChild:null===(c=u[23])||void 0===c?void 0:c[0]}})),s=e=>(null==e.firstChild||(e.children=n.filter((t=>t.parent===e.index)).map(s)),e);return n.filter((e=>0===e.headingLevel)).map(s)})(e,this.loadRecord.bind(this))}getMetadata(){var e,t,i;const{mobi:r,exth:n}=this.headers;return{identifier:r.uid.toString(),title:s((null===n||void 0===n?void 0:n.title)||this.decode(r.title)),author:null===n||void 0===n||null===(e=n.creator)||void 0===e?void 0:e.map(s),publisher:s(null===n||void 0===n?void 0:n.publisher),language:null!==(t=null===n||void 0===n?void 0:n.language)&&void 0!==t?t:r.language,published:null===n||void 0===n?void 0:n.date,description:s(null===n||void 0===n?void 0:n.description),subject:null===n||void 0===n||null===(i=n.subject)||void 0===i?void 0:i.map(s),rights:s(null===n||void 0===n?void 0:n.rights)}}async getCover(){const{exth:e}=this.headers,t=(null===e||void 0===e?void 0:e.coverOffset)<4294967295?null===e||void 0===e?void 0:e.coverOffset:(null===e||void 0===e?void 0:e.thumbnailOffset)<4294967295?null===e||void 0===e?void 0:e.thumbnailOffset:null;if(null!=t){const e=await this.loadResource(t);return new Blob([e])}}}function K(e){var t;const i=M(l,e),r=M(c,e);if("MOBI"!==r.magic)throw new Error("Missing MOBI header");const{titleOffset:n,titleLength:s,localeLanguage:o,localeRegion:a}=r;r.title=e.slice(n,n+s);const h=A[o];r.language=null!==(t=null===h||void 0===h?void 0:h[a>>2])&&void 0!==t?t:null===h||void 0===h?void 0:h[0];const f=64&r.exthFlag?((e,t)=>{const{magic:i,count:r}=M(d,e);if("EXTH"!==i)throw new Error("Invalid EXTH header");const n=L(t),s={};let o=12;for(let l=0;l<r;l++){const t=S(e.slice(o,o+4)),i=S(e.slice(o+4,o+8));if(t in w){const[r,l,c]=w[t],u=e.slice(o+8,o+i),d="uint"===l?S(u):n.decode(u);var a;c?(null!==(a=s[r])&&void 0!==a||(s[r]=[]),s[r].push(d)):s[r]=d}o+=i}return s})(e.slice(r.length+16),r.encoding):null;return{palmdoc:i,mobi:r,exth:f,kf8:r.version>=8?M(u,e):null}}async function W(){const{palmdoc:e,mobi:t}=this.headers;(0,r.A)(this,N)[N]=L(t.encoding),(0,r.A)(this,X)[X]=new TextEncoder;const{compression:i}=e;if((0,r.A)(this,G)[G]=1===i?e=>e:2===i?j:17480===i?await(async(e,t)=>{const i=await t(e.huffcdic),{magic:r,offset1:n,offset2:s}=M(g,i);if("HUFF"!==r)throw new Error("Invalid HUFF record");const o=Array.from({length:256},((e,t)=>n+4*t)).map((e=>S(i.slice(e,e+4)))).map((e=>[128&e,31&e,e>>>8])),a=[null].concat(Array.from({length:32},((e,t)=>s+8*t)).map((e=>[S(i.slice(e,e+4)),S(i.slice(e+4,e+8))]))),l=[];for(let u=1;u<e.numHuffcdic;u++){const i=await t(e.huffcdic+u),r=M(p,i);if("CDIC"!==r.magic)throw new Error("Invalid CDIC record");const n=Math.min(1<<r.codeLength,r.numEntries-l.length),s=i.slice(r.length);for(let e=0;e<n;e++){const t=S(s.slice(2*e,2*e+2)),i=S(s.slice(t,t+2)),r=32767&i,n=32768&i,o=new Uint8Array(s.slice(t+2,t+2+r));l.push([o,n])}}const c=e=>{let t=new Uint8Array;const i=8*e.byteLength;for(let r=0;r<i;){const n=Number(I(e,r));let[s,u,d]=o[n>>>24];if(!s){for(;n>>>32-u<a[u][0];)u+=1;d=a[u][1]}if((r+=u)>i)break;const h=d-(n>>>32-u);let[f,g]=l[h];g||(f=c(f),l[h]=[f,!0]),t=y(t,f)}return t};return c})(t,this.loadRecord.bind(this)):null,!(0,r.A)(this,G)[G])throw new Error("Unknown compression type");const{trailingFlags:n}=t,s=1&n,o=k(n>>>1);(0,r.A)(this,q)[q]=e=>{for(let t=0;t<o;t++){const t=E(e);e=e.subarray(0,-t)}if(s){const t=1+(3&e[e.length-1]);e=e.subarray(0,-t)}return e}}const J=/<\s*(?:mbp:)?pagebreak[^>]*>/gi,Q=/<[^<>]+filepos=['"]{0,1}(\d+)[^<>]*>/gi;var $=(0,n.A)("resourceCache"),_=(0,n.A)("textCache"),ee=(0,n.A)("cache"),te=(0,n.A)("sections"),ie=(0,n.A)("fileposList"),re=(0,n.A)("type");class ne{constructor(e){this.parser=new DOMParser,this.serializer=new XMLSerializer,Object.defineProperty(this,$,{writable:!0,value:new Map}),Object.defineProperty(this,_,{writable:!0,value:new Map}),Object.defineProperty(this,ee,{writable:!0,value:new Map}),Object.defineProperty(this,te,{writable:!0,value:void 0}),Object.defineProperty(this,ie,{writable:!0,value:[]}),Object.defineProperty(this,re,{writable:!0,value:o.HTML}),this.mobi=e}async init(){let e=new Uint8Array;for(let r=0;r<this.mobi.headers.palmdoc.numTextRecords;r++)e=y(e,await this.mobi.loadText(r));const t=Array.from(new Uint8Array(e),(e=>String.fromCharCode(e))).join("");(0,r.A)(this,te)[te]=[0].concat(Array.from(t.matchAll(J),(e=>e.index))).map(((e,i,r)=>t.slice(e,r[i+1]))).map((e=>Uint8Array.from(e,(e=>e.charCodeAt(0))))).map((e=>({book:this,raw:e}))).reduce(((e,t)=>{var i;const r=e[e.length-1];return t.start=null!==(i=null===r||void 0===r?void 0:r.end)&&void 0!==i?i:0,t.end=t.start+t.raw.byteLength,e.concat(t)}),[]),this.sections=(0,r.A)(this,te)[te].map(((e,t)=>({id:t,load:()=>this.loadSection(e),createDocument:()=>this.createDocument(e),size:e.end-e.start})));try{var i;this.landmarks=await this.getGuide();const e=null===(i=this.landmarks.find((e=>{let{type:t}=e;return null===t||void 0===t?void 0:t.includes("toc")})))||void 0===i?void 0:i.href;if(e){const{index:t}=this.resolveHref(e),i=await this.sections[t].createDocument();let r,n=0,s=0;const o=new Map,a=new Map;this.toc=Array.from(i.querySelectorAll("a[filepos]")).reduce(((e,t)=>{var i,l;const c=(e=>{let t=0;for(;e;){const i=e.parentElement;if(i){const e=i.tagName.toLowerCase();"p"===e?t+=1.5:"blockquote"===e&&(t+=2)}e=i}return t})(t),u={label:null===(i=t.innerText)||void 0===i?void 0:i.trim(),href:"filepos:".concat(t.getAttribute("filepos"))},d=c>s?n+1:c===s?n:null!==(l=o.get(c))&&void 0!==l?l:Math.max(0,n-1);if(d>n){var h,f;if(r)null!==(f=(h=r).subitems)&&void 0!==f||(h.subitems=[]),r.subitems.push(u),a.set(d,r);else e.push(u)}else{const t=a.get(d);t?t.subitems.push(u):e.push(u)}return r=u,n=d,s=c,o.set(c,d),e}),[])}}catch(n){console.warn(n)}return(0,r.A)(this,ie)[ie]=[...new Set(Array.from(t.matchAll(Q),(e=>e[1])))].map((e=>({filepos:e,number:Number(e)}))).sort(((e,t)=>e.number-t.number)),this.metadata=this.mobi.getMetadata(),this.getCover=this.mobi.getCover.bind(this.mobi),this}async getGuide(){const e=await this.createDocument((0,r.A)(this,te)[te][0]);return Array.from(e.getElementsByTagName("reference"),(e=>{var t;return{label:e.getAttribute("title"),type:null===(t=e.getAttribute("type"))||void 0===t?void 0:t.split(/\s/),href:"filepos:".concat(e.getAttribute("filepos"))}}))}async loadResource(e){if((0,r.A)(this,$)[$].has(e))return(0,r.A)(this,$)[$].get(e);const t=await this.mobi.loadResource(e),i=URL.createObjectURL(new Blob([t]));return(0,r.A)(this,$)[$].set(e,i),i}async loadRecindex(e){return this.loadResource(Number(e)-1)}async replaceResources(e){for(const t of e.querySelectorAll("img[recindex]")){const e=t.getAttribute("recindex");try{t.src=await this.loadRecindex(e)}catch{console.warn("Failed to load image ".concat(e))}}for(const t of e.querySelectorAll("[mediarecindex]")){const e=t.getAttribute("mediarecindex"),i=t.getAttribute("recindex");try{t.src=await this.loadRecindex(e),i&&(t.poster=await this.loadRecindex(i))}catch{console.warn("Failed to load media ".concat(e))}}for(const t of e.querySelectorAll("[filepos]")){const e=t.getAttribute("filepos");t.href="filepos:".concat(e)}}async loadText(e){if((0,r.A)(this,_)[_].has(e))return(0,r.A)(this,_)[_].get(e);const{raw:t}=e,i=(0,r.A)(this,ie)[ie].filter((t=>{let{number:i}=t;return i>=e.start&&i<e.end})).map((t=>({...t,offset:t.number-e.start})));let n=t;i.length&&(n=t.subarray(0,i[0].offset),i.forEach(((e,r)=>{let{filepos:s,offset:o}=e;const a=i[r+1],l=this.mobi.encode('<a id="filepos'.concat(s,'"></a>'));n=x(n,l,t.subarray(o,null===a||void 0===a?void 0:a.offset))})));const s=this.mobi.decode(n).replaceAll(J,"");return(0,r.A)(this,_)[_].set(e,s),s}async createDocument(e){const t=await this.loadText(e);return this.parser.parseFromString(t,(0,r.A)(this,re)[re])}async loadSection(e){if((0,r.A)(this,ee)[ee].has(e))return(0,r.A)(this,ee)[ee].get(e);const t=await this.createDocument(e),i=t.createElement("style");t.head.append(i),i.append(t.createTextNode("blockquote {\n            margin-block-start: 0;\n            margin-block-end: 0;\n            margin-inline-start: 1em;\n            margin-inline-end: 0;\n        }")),await this.replaceResources(t);const n=this.serializer.serializeToString(t),s=URL.createObjectURL(new Blob([n],{type:(0,r.A)(this,re)[re]}));return(0,r.A)(this,ee)[ee].set(e,s),s}resolveHref(e){const t=e.match(/filepos:(.*)/)[1],i=Number(t);return{index:(0,r.A)(this,te)[te].findIndex((e=>e.end>i)),anchor:e=>e.getElementById("filepos".concat(t))}}splitTOCHref(e){const t=e.match(/filepos:(.*)/)[1],i=Number(t);return[(0,r.A)(this,te)[te].findIndex((e=>e.end>i)),"filepos".concat(t)]}getTOCFragment(e,t){return e.getElementById(t)}isExternal(e){return/^(?!blob|filepos)\w+:/i.test(e)}destroy(){for(const e of(0,r.A)(this,$)[$].values())URL.revokeObjectURL(e);for(const e of(0,r.A)(this,ee)[ee].values())URL.revokeObjectURL(e)}}const se=/kindle:(flow|embed):(\w+)(?:\?mime=(\w+\/[-+.\w]+))?/,oe=/kindle:pos:fid:(\w+):off:(\w+)/,ae=e=>{const[t,i]=e.match(oe).slice(1);return{fid:parseInt(t,32),off:parseInt(i,32)}},le=function(){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return"kindle:pos:fid:".concat((arguments.length>0&&void 0!==arguments[0]?arguments[0]:0).toString(32).toUpperCase().padStart(4,"0"),":off:").concat(e.toString(32).toUpperCase().padStart(10,"0"))},ce=e=>{const t=e.match(/\s(id|name|aid)\s*=\s*['"]([^'"]*)['"]/i);if(!t)return;const[,i,r]=t;return"[".concat(i,'="').concat(CSS.escape(r),'"]')},ue=e=>{for(const t of e){if("page-spread-left"===t||"rendition:page-spread-left"===t)return"left";if("page-spread-right"===t||"rendition:page-spread-right"===t)return"right";if("rendition:page-spread-center"===t)return"center"}};var de=(0,n.A)("cache"),he=(0,n.A)("fragmentOffsets"),fe=(0,n.A)("fragmentSelectors"),ge=(0,n.A)("tables"),pe=(0,n.A)("sections"),me=(0,n.A)("fullRawLength"),be=(0,n.A)("rawHead"),ve=(0,n.A)("rawTail"),we=(0,n.A)("lastLoadedHead"),Ae=(0,n.A)("lastLoadedTail"),ye=(0,n.A)("type"),xe=(0,n.A)("inlineMap"),Re=(0,n.A)("setFragmentSelector");class Oe{constructor(e){Object.defineProperty(this,Re,{value:Se}),this.parser=new DOMParser,this.serializer=new XMLSerializer,Object.defineProperty(this,de,{writable:!0,value:new Map}),Object.defineProperty(this,he,{writable:!0,value:new Map}),Object.defineProperty(this,fe,{writable:!0,value:new Map}),Object.defineProperty(this,ge,{writable:!0,value:{}}),Object.defineProperty(this,pe,{writable:!0,value:void 0}),Object.defineProperty(this,me,{writable:!0,value:void 0}),Object.defineProperty(this,be,{writable:!0,value:new Uint8Array}),Object.defineProperty(this,ve,{writable:!0,value:new Uint8Array}),Object.defineProperty(this,we,{writable:!0,value:-1}),Object.defineProperty(this,Ae,{writable:!0,value:-1}),Object.defineProperty(this,ye,{writable:!0,value:o.XHTML}),Object.defineProperty(this,xe,{writable:!0,value:new Map}),this.mobi=e}async init(){var e,t,i,n;const a=this.mobi.loadRecord.bind(this.mobi),{kf8:l}=this.mobi.headers;try{const e=await a(l.fdst),t=M(m,e);if("FDST"!==t.magic)throw new Error("Missing FDST record");const i=Array.from({length:t.numEntries},((e,t)=>12+8*t)).map((t=>[S(e.slice(t,t+4)),S(e.slice(t+4,t+8))]));(0,r.A)(this,ge)[ge].fdstTable=i,(0,r.A)(this,me)[me]=i[i.length-1][1]}catch{}const c=(await U(l.skel,a)).table.map(((e,t)=>{let{name:i,tagMap:r}=e;return{index:t,name:i,numFrag:r[1][0],offset:r[6][0],length:r[6][1]}})),u=await U(l.frag,a),d=u.table.map((e=>{let{name:t,tagMap:i}=e;return{insertOffset:parseInt(t),selector:u.cncx[i[2][0]],index:i[4][0],offset:i[6][0],length:i[6][1]}}));(0,r.A)(this,ge)[ge].skelTable=c,(0,r.A)(this,ge)[ge].fragTable=d,(0,r.A)(this,pe)[pe]=c.reduce(((e,t)=>{var i,r;const n=e[e.length-1],s=null!==(i=null===n||void 0===n?void 0:n.fragEnd)&&void 0!==i?i:0,o=s+t.numFrag,a=d.slice(s,o),l=t.length+a.map((e=>e.length)).reduce(((e,t)=>e+t)),c=(null!==(r=null===n||void 0===n?void 0:n.totalLength)&&void 0!==r?r:0)+l;return e.concat({skel:t,frags:a,fragEnd:o,length:l,totalLength:c})}),[]);const h=await this.getResourcesByMagic(["RESC","PAGE"]),f=new Map;if(h.RESC){const e=await this.mobi.loadRecord(h.RESC),t=this.mobi.decode(e.slice(16)).replace(/\0/g,""),i=t.search(/\?>/),r="<package>".concat(t.slice(i),"</package>"),n=this.parser.parseFromString(r,o.XML);for(const s of n.querySelectorAll("spine > itemref")){var g,p;const e=parseInt(s.getAttribute("skelid"));f.set(e,ue(null!==(g=null===(p=s.getAttribute("properties"))||void 0===p?void 0:p.split(" "))&&void 0!==g?g:[]))}}this.sections=(0,r.A)(this,pe)[pe].map(((e,t)=>e.frags.length?{id:t,load:()=>this.loadSection(e),createDocument:()=>this.createDocument(e),size:e.length,pageSpread:f.get(t)}:{linear:"no"}));try{const e=await this.mobi.getNCX(),t=e=>{let{label:i,pos:n,children:o}=e;const[a,l]=n,c=le(a,l),u=(0,r.A)(this,he)[he].get(a);return u?u.push(l):(0,r.A)(this,he)[he].set(a,[l]),{label:s(i),href:c,subitems:null===o||void 0===o?void 0:o.map(t)}};this.toc=null===e||void 0===e?void 0:e.map(t),this.landmarks=await this.getGuide()}catch(v){console.warn(v)}const{exth:b}=this.mobi.headers;return this.dir=b.pageProgressionDirection,this.rendition={layout:"true"===b.fixedLayout?"pre-paginated":"reflowable",viewport:Object.fromEntries(null!==(e=null===(t=b.originalResolution)||void 0===t||null===(i=t.split("x"))||void 0===i||null===(n=i.slice(0,2))||void 0===n?void 0:n.map(((e,t)=>[t?"height":"width",e])))&&void 0!==e?e:[])},this.metadata=this.mobi.getMetadata(),this.getCover=this.mobi.getCover.bind(this.mobi),this}async getResourcesByMagic(e){const t={},i=this.mobi.headers.kf8.resourceStart,r=this.mobi.pdb.numRecords;for(let n=i;n<r;n++)try{const i=await this.mobi.loadMagic(n),r=e.find((e=>e===i));r&&(t[r]=n)}catch{}return t}async getGuide(){const e=this.mobi.headers.kf8.guide;if(e<4294967295){const t=this.mobi.loadRecord.bind(this.mobi),{table:i,cncx:r}=await U(e,t);return i.map((e=>{var t,i,n,s;let{name:o,tagMap:a}=e;return{label:null!==(t=r[a[1][0]])&&void 0!==t?t:"",type:null===o||void 0===o?void 0:o.split(/\s/),href:le(null!==(i=null===(n=a[6])||void 0===n?void 0:n[0])&&void 0!==i?i:null===(s=a[3])||void 0===s?void 0:s[0])}}))}}async loadResourceBlob(e){var t;const{resourceType:i,id:r,type:n}=(e=>{const[t,i,r]=e.match(se).slice(1);return{resourceType:t,id:parseInt(i,32),type:r}})(e),s="flow"===i?await this.loadFlow(r):await this.mobi.loadResource(r-1),a=[o.XHTML,o.HTML,o.CSS,o.SVG].includes(n)?await this.replaceResources(this.mobi.decode(s)):s,l=n===o.SVG?this.parser.parseFromString(a,n):null;return[new Blob([a],{type:n}),null!==l&&void 0!==l&&null!==(t=l.getElementsByTagNameNS("http://www.w3.org/2000/svg","image"))&&void 0!==t&&t.length?l.documentElement:null]}async loadResource(e){if((0,r.A)(this,de)[de].has(e))return(0,r.A)(this,de)[de].get(e);const[t,i]=await this.loadResourceBlob(e),n=i?e:URL.createObjectURL(t);return i&&(0,r.A)(this,xe)[xe].set(n,i),(0,r.A)(this,de)[de].set(e,n),n}replaceResources(e){return(async(e,t,i)=>{const r=[];e.replace(t,(function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return r.push(t),null}));const n=[];for(const s of r)n.push(await i(...s));return e.replace(t,(()=>n.shift()))})(e,new RegExp(se,"g"),this.loadResource.bind(this))}async loadRaw(e,t){const i=t-(0,r.A)(this,be)[be].length,n=null==(0,r.A)(this,me)[me]?1/0:(0,r.A)(this,me)[me]-(0,r.A)(this,ve)[ve].length-e;if(i<0||i<n){for(;(0,r.A)(this,be)[be].length<t;){const e=++(0,r.A)(this,we)[we],t=await this.mobi.loadText(e);(0,r.A)(this,be)[be]=y((0,r.A)(this,be)[be],t)}return(0,r.A)(this,be)[be].slice(e,t)}for(;(0,r.A)(this,me)[me]-(0,r.A)(this,ve)[ve].length>e;){const e=this.mobi.headers.palmdoc.numTextRecords-1-++(0,r.A)(this,Ae)[Ae],t=await this.mobi.loadText(e);(0,r.A)(this,ve)[ve]=y(t,(0,r.A)(this,ve)[ve])}const s=(0,r.A)(this,me)[me]-(0,r.A)(this,ve)[ve].length;return(0,r.A)(this,ve)[ve].slice(e-s,t-s)}loadFlow(e){if(e<4294967295)return this.loadRaw(...(0,r.A)(this,ge)[ge].fdstTable[e])}async loadText(e){const{skel:t,frags:i,length:n}=e,s=await this.loadRaw(t.offset,t.offset+n);let o=s.slice(0,t.length);for(const a of i){const e=a.insertOffset-t.offset,i=t.length+a.offset,n=s.slice(i,i+a.length);o=x(o.slice(0,e),n,o.slice(e));const l=(0,r.A)(this,he)[he].get(a.index);if(l)for(const t of l){const e=this.mobi.decode(n).slice(t),i=ce(e);(0,r.A)(this,Re)[Re](a.index,t,i)}}return this.mobi.decode(o)}async createDocument(e){const t=await this.loadText(e);return this.parser.parseFromString(t,(0,r.A)(this,ye)[ye])}async loadSection(e){if((0,r.A)(this,de)[de].has(e))return(0,r.A)(this,de)[de].get(e);const t=await this.loadText(e),i=await this.replaceResources(t);let n=this.parser.parseFromString(i,(0,r.A)(this,ye)[ye]);n.querySelector("parsererror")&&((0,r.A)(this,ye)[ye]=o.HTML,n=this.parser.parseFromString(i,(0,r.A)(this,ye)[ye]));for(const[o,a]of(0,r.A)(this,xe)[xe])for(const e of n.querySelectorAll('img[src="'.concat(o,'"]')))e.replaceWith(a);const s=URL.createObjectURL(new Blob([this.serializer.serializeToString(n)],{type:(0,r.A)(this,ye)[ye]}));return(0,r.A)(this,de)[de].set(e,s),s}getIndexByFID(e){return(0,r.A)(this,pe)[pe].findIndex((t=>t.frags.some((t=>t.index===e))))}async resolveHref(e){var t;const{fid:i,off:n}=ae(e),s=this.getIndexByFID(i);if(s<0)return;const o=null===(t=(0,r.A)(this,fe)[fe].get(i))||void 0===t?void 0:t.get(n);if(o)return{index:s,anchor:e=>e.querySelector(o)};const{skel:a,frags:l}=(0,r.A)(this,pe)[pe][s],c=l.find((e=>e.index===i)),u=a.offset+a.length+c.offset,d=await this.loadRaw(u,u+c.length),h=this.mobi.decode(d).slice(n),f=ce(h);(0,r.A)(this,Re)[Re](i,n,f);return{index:s,anchor:e=>e.querySelector(f)}}splitTOCHref(e){const t=ae(e);return[this.getIndexByFID(t.fid),t]}getTOCFragment(e,t){var i;let{fid:n,off:s}=t;const o=null===(i=(0,r.A)(this,fe)[fe].get(n))||void 0===i?void 0:i.get(s);return e.querySelector(o)}isExternal(e){return/^(?!blob|kindle)\w+:/i.test(e)}destroy(){for(const e of(0,r.A)(this,de)[de].values())URL.revokeObjectURL(e)}}function Se(e,t,i){const n=(0,r.A)(this,fe)[fe].get(e);if(n)n.set(t,i);else{const n=new Map;(0,r.A)(this,fe)[fe].set(e,n),n.set(t,i)}}}}]);
//# sourceMappingURL=149.8e23c370.chunk.js.map